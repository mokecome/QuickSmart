# QuickSmart 智能記帳 - 用戶流程圖

**版本**: v1.0
**日期**: 2025-10-21
**基於**: PRD_SDD.md, user_story.md, EVENT_STORMING.md

---

## 📋 目錄

1. [新用戶首次使用流程](#新用戶首次使用流程)
2. [核心記帳流程](#核心記帳流程)
3. [訂閱管理流程](#訂閱管理流程)
4. [AI 分類修正流程](#ai-分類修正流程)
5. [查看分析報告流程](#查看分析報告流程)
6. [設定管理流程](#設定管理流程)
7. [Telegram Bot 使用流程](#telegram-bot-使用流程)

---

## 🆕 新用戶首次使用流程

### 流程目標
- 3 分鐘內完成首次記帳 (Aha Moment)
- 理解產品核心價值
- 養成記帳習慣

### 完整流程圖

```
┌─────────────┐
│  開啟 App   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  登入/註冊  │ ← 步驟 0
│             │
│ • Google    │
│ • Email     │
└──────┬──────┘
       │
       ▼
 [已有帳號?]
       │
   ┌───┴───┐
   │       │
   ▼       ▼
 [是]    [否]
   │       │
   │       ▼
   │  ┌─────────────┐
   │  │ 歡迎畫面    │ ← 步驟 1
   │  │             │
   │  │ "歡迎使用!" │
   │  └──────┬──────┘
   │         │
   │         ▼
   │  ┌─────────────┐
   │  │ 功能介紹    │ ← 步驟 2
   │  │ (輪播 3 頁) │
   │  │             │
   │  │ • 自然語言  │
   │  │ • 訂閱管理  │
   │  │ • AI 分析   │
   │  └──────┬──────┘
   │         │
   └─────────┤
             ▼
      ┌─────────────┐
      │ 首次記帳    │ ← 步驟 3
      │             │
      │ "試試看:    │
      │  早餐 65"   │
      └──────┬──────┘
             │
             ▼
      [輸入文字]
             │
             ▼
      ┌─────────────┐
      │ AI 解析     │
      │ (500ms)     │
      └──────┬──────┘
             │
             ▼
      ┌─────────────┐
      │ 顯示預覽    │
      │             │
      │ ✅ 金額 65  │
      │ 🍽️ 餐飲 95% │
      │ 📅 今天     │
      └──────┬──────┘
             │
             ▼
      [用戶確認]
             │
             ▼
      ┌─────────────┐
      │ ✨ 成功!    │ ← 🎉 Aha Moment!
      │             │
      │ 慶祝動畫    │
      │ 彩帶效果    │
      └──────┬──────┘
             │
             ▼
   [鼓勵繼續記帳]
             │
       ┌─────┴─────┐
       │           │
       ▼           ▼
   [再記一筆]  [跳過]
       │           │
       │           └────┐
       ▼                │
  ┌─────────┐          │
  │ 第2筆   │          │
  └────┬────┘          │
       │               │
       ▼               │
  ┌─────────┐          │
  │ 第3筆   │          │
  └────┬────┘          │
       │               │
       ▼               │
  ┌─────────────┐      │
  │ 🎊 解鎖分析  │      │
  │             │      │
  │ 顯示圓餅圖  │      │
  └─────┬───────┘      │
        │              │
        └──────┬───────┘
               │
               ▼
        ┌─────────────┐
        │  進入主頁   │
        │             │
        │ onboarding  │
        │ Completed✅ │
        └─────────────┘
```

### 關鍵決策點

| 決策點 | 選項 | 後果 |
|--------|------|------|
| 已有帳號? | 是 | 跳過功能介紹，直接首次記帳 |
| 已有帳號? | 否 | 完整 Onboarding 流程 |
| 功能介紹 | 跳過 | 直接首次記帳 |
| 首次記帳 | 再記一筆 | 記滿 3 筆解鎖分析 |
| 首次記帳 | 跳過 | 直接進入主頁 |

### 成功指標
- ✅ 70% 用戶完成首次記帳
- ✅ 50% 用戶記滿 3 筆
- ✅ 平均完成時間 < 3 分鐘

---

## 💰 核心記帳流程

### 標準記帳流程 (快樂路徑)

```
┌─────────────┐
│  主頁       │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 點擊輸入框  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 輸入文字    │
│ "午餐 120"  │
└──────┬──────┘
       │
       ▼ (即時)
┌─────────────┐
│ AI 解析中   │
│ "💡 AI     │
│  建議中..." │
└──────┬──────┘
       │
       ▼ (500ms)
┌─────────────┐
│ 顯示預覽    │
│             │
│ ✅ NT$120   │
│ 🍽️ 餐飲     │
│ 📅 今天     │
│ 信心度 95%  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 點擊確認    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 儲存中...   │
│ (樂觀更新)  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ ✨ 已記帳!  │
│             │
│ 成功動畫    │
│ (1.5s)      │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 清空輸入框  │
│ 新記錄浮現  │
│             │
│ 準備下一筆  │
└─────────────┘
```

### AI 低信心度流程 (替代路徑)

```
┌─────────────┐
│ 輸入文字    │
│ "xyz 100"   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ AI 解析     │
│ 信心度 30%  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ ⚠️ AI不確定 │
│             │
│ 建議: 其他  │
│             │
│ 請選擇分類: │
│ 🍽️ 🚇 🛍️ 📺 │
└──────┬──────┘
       │
       ▼
[用戶選擇分類]
       │
       ▼
┌─────────────┐
│ 儲存 +      │
│ 記錄學習樣本│
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ ✨ 已記帳!  │
│             │
│ "AI 會學習" │
└─────────────┘
```

### AI 服務失敗流程 (錯誤處理)

```
┌─────────────┐
│ 輸入文字    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 呼叫 AI API │
└──────┬──────┘
       │
       ▼
 [API 狀態?]
       │
   ┌───┴───┐
   │       │
   ▼       ▼
[成功]  [失敗/超時]
   │       │
   │       ▼
   │  ┌─────────────┐
   │  │ 自動切換    │
   │  │ 降級模式    │
   │  └──────┬──────┘
   │         │
   │         ▼
   │  ┌─────────────┐
   │  │ 規則引擎    │
   │  │ 解析        │
   │  └──────┬──────┘
   │         │
   │         ▼
   │  ┌─────────────┐
   │  │ 顯示預覽    │
   │  │ (信心度70%) │
   │  │ fallback✅  │
   │  └──────┬──────┘
   │         │
   │         ▼
   │  ┌─────────────┐
   │  │ 顯示提示    │
   │  │ "AI暫時休息"│
   │  └──────┬──────┘
   │         │
   └─────────┤
             ▼
      [繼續正常流程]
```

### 時間軸 (理想狀態)

```
0ms      用戶輸入「午餐 120」
         ↓
100ms    輸入框顯示「AI 建議中...」
         ↓
500ms    AI 解析完成，顯示預覽
         ↓
1000ms   用戶點擊確認
         ↓
1100ms   樂觀更新 UI
         ↓
1500ms   顯示成功動畫
         ↓
1800ms   清空輸入框
         ↓
2200ms   新記錄滑入列表
         ↓
2700ms   成功動畫淡出
         ↓
3000ms   準備下一筆
```

---

## 📅 訂閱管理流程

### 新增訂閱流程

```
┌─────────────┐
│ 訂閱頁面    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 點擊 + 按鈕 │
└──────┬──────┘
       │
       ▼
┌─────────────────────┐
│ 新增訂閱表單        │
│                     │
│ • 服務名稱          │
│ • 金額              │
│ • 扣款週期 (月/年)  │
│ • 首次扣款日        │
│ • 分類 (選填)       │
└──────┬──────────────┘
       │
       ▼
 [即時驗證]
       │
   ┌───┴───┐
   │       │
   ▼       ▼
 [有錯誤] [無錯誤]
   │       │
   │       ▼
   │  ┌─────────────┐
   │  │ 顯示預覽    │
   │  │             │
   │  │ 下次扣款:   │
   │  │ 2025-11-15  │
   │  └──────┬──────┘
   │         │
   │         ▼
   │  ┌─────────────┐
   │  │ 點擊儲存    │
   │  └──────┬──────┘
   │         │
   │         ▼
   │  ┌─────────────┐
   │  │ 後端處理    │
   │  │ • 儲存資料  │
   │  │ • 計算日期  │
   │  │ • 排程提醒  │
   │  └──────┬──────┘
   │         │
   └─────────┤
             ▼
      ┌─────────────┐
      │ ✅ 新增成功 │
      │             │
      │ 返回列表    │
      └─────────────┘
```

### 訂閱提醒流程 (Cron Job)

```
┌─────────────┐
│ Cron Job    │
│ 每日 00:00  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 查詢資料庫  │
│             │
│ WHERE       │
│ nextBilling │
│ IN (今天+1, │
│     今天+3) │
└──────┬──────┘
       │
       ▼
 [找到訂閱?]
       │
   ┌───┴───┐
   │       │
   ▼       ▼
 [否]    [是]
   │       │
   │       ├─→ [3天後] → 發送「3天後扣款」通知
   │       │
   │       ├─→ [1天後] → 發送「明天扣款」通知
   │       │
   │       └─→ [今天] → ┌─────────────┐
   │                    │ 自動記帳    │
   │                    │ • 創建支出  │
   │                    │ • 更新日期  │
   │                    └──────┬──────┘
   │                           │
   │                           ▼
   │                    ┌─────────────┐
   │                    │ 發送通知    │
   │                    │ "已自動記帳"│
   │                    └──────┬──────┘
   │                           │
   └───────────────────────────┘
                               │
                               ▼
                        ┌─────────────┐
                        │ 記錄日誌    │
                        └─────────────┘
```

### 取消訂閱流程

```
┌─────────────┐
│ 訂閱詳情頁  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 點擊「取消  │
│  訂閱」     │
└──────┬──────┘
       │
       ▼
┌─────────────────────┐
│ ⚠️ 確認對話框        │
│                     │
│ "確定要取消?"       │
│                     │
│ 取消原因:           │
│ • 不再使用          │
│ • 太貴了            │
│ • 換其他服務        │
└──────┬──────────────┘
       │
   ┌───┴───┐
   │       │
   ▼       ▼
 [取消]  [確認]
   │       │
   │       ▼
   │  ┌─────────────┐
   │  │ 更新狀態    │
   │  │ CANCELLED   │
   │  └──────┬──────┘
   │         │
   │         ▼
   │  ┌─────────────┐
   │  │ 停止提醒    │
   │  └──────┬──────┘
   │         │
   │         ▼
   │  ┌─────────────┐
   │  │ 記錄原因    │
   │  │ (Analytics) │
   │  └──────┬──────┘
   │         │
   └─────────┤
             ▼
      ┌─────────────┐
      │ 返回列表    │
      │             │
      │ 顯示半透明  │
      └─────────────┘
```

---

## 🔄 AI 分類修正流程

### 完整修正流程

```
┌─────────────┐
│ 支出列表    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 點擊記錄    │
│ (AI分類錯誤)│
└──────┬──────┘
       │
       ▼
┌─────────────────────┐
│ 編輯對話框          │
│                     │
│ 當前分類: 娛樂 ❌   │
│ 信心度: 65%         │
│                     │
│ 選擇正確分類:       │
│ 🍽️ 🚇 🛍️ 📺 🏠     │
└──────┬──────────────┘
       │
       ▼
[用戶選擇「交通」]
       │
       ▼
┌─────────────┐
│ 點擊「儲存  │
│  並教導AI」 │
└──────┬──────┘
       │
       ▼
┌─────────────────────┐
│ 後端處理            │
│                     │
│ 1. 更新分類         │
│ 2. version++        │
│ 3. 儲存學習樣本:    │
│    {                │
│      input: "...",  │
│      correct: "..." │
│    }                │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│ 觸發事件            │
│                     │
│ • CategoryCorrected │
│ • AILearned         │
└──────┬──────────────┘
       │
       ▼
┌─────────────┐
│ ✅ 已更新!  │
│             │
│ "AI會記住   │
│  這個修正🧠"│
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 更新列表    │
│ 顯示新分類  │
└─────────────┘
```

### 學習效果驗證流程

```
[修正 5 次後]
       │
       ▼
┌─────────────┐
│ 用戶再次    │
│ 輸入類似內容│
│ "Uber去公司"│
└──────┬──────┘
       │
       ▼
┌─────────────────────┐
│ AI 解析             │
│                     │
│ 1. 載入學習樣本     │
│ 2. 參考歷史修正     │
│ 3. 調整信心度       │
└──────┬──────────────┘
       │
       ▼
┌─────────────┐
│ 返回結果    │
│             │
│ 分類: 交通✅│
│ 信心度: 95%↗│
│ (原本 65%)  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 顯示提示    │
│ "AI根據你的"│
│ "習慣判斷" │
└─────────────┘
```

---

## 📊 查看分析報告流程

### 基本查看流程

```
┌─────────────┐
│ 底部導航    │
│ 點擊「分析」│
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 載入資料    │
│ (快取優先)  │
└──────┬──────┘
       │
       ▼
┌─────────────────────┐
│ 分析總覽頁          │
│                     │
│ • 本月支出 NT$15K   │
│ • AI 洞察 (3條)     │
│ • 圓餅圖            │
│ • 趨勢折線圖        │
└──────┬──────────────┘
       │
   ┌───┴───┐
   │       │
   ▼       ▼
[查看洞察] [查看分類]
   │       │
   │       ▼
   │  ┌─────────────┐
   │  │ 單一分類    │
   │  │ 詳情頁      │
   │  │             │
   │  │ • 統計數據  │
   │  │ • 子分類    │
   │  │ • 最近記錄  │
   │  └─────────────┘
   │
   ▼
┌─────────────────────┐
│ AI 洞察詳情         │
│                     │
│ • 消費習慣分析      │
│ • 趨勢識別          │
│ • 省錢建議          │
│ • 反饋按鈕          │
└──────┬──────────────┘
       │
       ▼
[點擊「有用」/「忽略」]
       │
       ▼
┌─────────────┐
│ 記錄反饋    │
│ (Analytics) │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 顯示感謝    │
│ 或隱藏洞察  │
└─────────────┘
```

### 切換月份流程

```
┌─────────────┐
│ 分析頁面    │
│ 當前: 10月  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 點擊月份    │
│ 選擇器      │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 下拉選單    │
│             │
│ • 2025-10✓ │
│ • 2025-09   │
│ • 2025-08   │
└──────┬──────┘
       │
       ▼
[選擇「2025-09」]
       │
       ▼
┌─────────────┐
│ 載入中...   │
│ (骨架屏)    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 顯示 9 月   │
│ 資料        │
│             │
│ • 總支出    │
│ • 圓餅圖    │
│ • 洞察      │
└─────────────┘
```

---

## ⚙️ 設定管理流程

### 連結 Telegram 流程

```
┌─────────────┐
│ 設定頁面    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 點擊        │
│ "Telegram   │
│  連結"      │
└──────┬──────┘
       │
       ▼
 [連結狀態?]
       │
   ┌───┴───┐
   │       │
   ▼       ▼
 [已連結] [未連結]
   │       │
   │       ▼
   │  ┌─────────────────────┐
   │  │ 連結引導頁          │
   │  │                     │
   │  │ • 功能介紹          │
   │  │ • 步驟說明          │
   │  │ • QR Code           │
   │  └──────┬──────────────┘
   │         │
   │         ▼
   │  ┌─────────────┐
   │  │ 點擊        │
   │  │ "開啟Bot"   │
   │  └──────┬──────┘
   │         │
   │         ▼
   │  ┌─────────────┐
   │  │ 開啟Telegram│
   │  │ App         │
   │  └──────┬──────┘
   │         │
   │         ▼
   │  [用戶輸入 /start]
   │         │
   │         ▼
   │  ┌─────────────────────┐
   │  │ Bot 回應            │
   │  │                     │
   │  │ "請輸入驗證碼:"     │
   │  │ ABC123              │
   │  └──────┬──────────────┘
   │         │
   │         ▼
   │  [用戶貼上驗證碼]
   │         │
   │         ▼
   │  ┌─────────────┐
   │  │ 驗證成功    │
   │  │             │
   │  │ telegramId  │
   │  │ 已儲存      │
   │  └──────┬──────┘
   │         │
   └─────────┤
             ▼
      ┌─────────────┐
      │ ✅ 連結成功 │
      │             │
      │ 顯示快速    │
      │ 指令列表    │
      └─────────────┘
```

### 修改通知設定流程

```
┌─────────────┐
│ 設定頁面    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 點擊        │
│ "通知設定"  │
└──────┬──────┘
       │
       ▼
┌─────────────────────┐
│ 通知設定頁          │
│                     │
│ 推播:               │
│ • 訂閱提醒 [●  ]   │
│ • AI洞察   [●  ]   │
│ • 記帳提醒 [○  ]   │
│                     │
│ Email:              │
│ • 訂閱提醒 [●  ]   │
│ • 月度報告 [●  ]   │
└──────┬──────────────┘
       │
       ▼
[點擊開關]
       │
       ▼
┌─────────────┐
│ 樂觀更新UI  │
│ (開關切換)  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 發送API請求 │
└──────┬──────┘
       │
   ┌───┴───┐
   │       │
   ▼       ▼
 [成功]  [失敗]
   │       │
   │       ▼
   │  ┌─────────────┐
   │  │ 回滾UI      │
   │  │ 顯示錯誤    │
   │  └──────┬──────┘
   │         │
   └─────────┘
```

---

## 💬 Telegram Bot 使用流程

### 透過 Bot 記帳

```
[Telegram App]
       │
       ▼
┌─────────────┐
│ 用戶輸入    │
│ "午餐 120"  │
└──────┬──────┘
       │
       ▼
┌─────────────────────┐
│ Bot 接收訊息        │
│                     │
│ • Webhook 觸發      │
│ • 驗證 telegramId   │
│ • 找到對應 userId   │
└──────┬──────────────┘
       │
       ▼
┌─────────────┐
│ 呼叫        │
│ parseExpense│
│ API         │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ AI 解析     │
│ (同 App)    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 儲存記錄    │
└──────┬──────┘
       │
       ▼
┌─────────────────────┐
│ Bot 回覆            │
│                     │
│ "✅ 已記帳"         │
│ "金額: NT$120"      │
│ "分類: 餐飲"        │
│ "信心度: 95%"       │
└─────────────────────┘
```

### 透過 Bot 查詢

```
[Telegram App]
       │
       ▼
┌─────────────┐
│ 用戶輸入    │
│ "/today"    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ Bot 辨識    │
│ 指令        │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 查詢今日    │
│ 支出        │
└──────┬──────┘
       │
       ▼
┌─────────────────────┐
│ Bot 回覆            │
│                     │
│ "📊 今日支出"       │
│ "總計: NT$320"      │
│                     │
│ "早餐 NT$65"        │
│ "午餐 NT$120"       │
│ "咖啡 NT$135"       │
└─────────────────────┘
```

---

## 📊 流程指標追蹤

### 關鍵漏斗

```
新用戶漏斗:
100% 開啟 App
  ↓ -10%
 90% 完成註冊
  ↓ -20%
 70% 完成首次記帳 ✅ (目標)
  ↓ -20%
 50% 記滿 3 筆 ✅ (目標)
  ↓ -10%
 40% 完成 Onboarding
  ↓ -20%
 20% 7日後仍活躍

記帳漏斗:
100% 開啟輸入框
  ↓ -5%
 95% 輸入文字
  ↓ -3%
 92% AI 解析成功
  ↓ -2%
 90% 點擊確認 ✅ (目標)
```

### 時間指標

| 流程 | 目標時間 | P95 | 測量方式 |
|------|---------|-----|----------|
| 首次記帳 | < 3 分鐘 | 5 分鐘 | 註冊 → 首次記帳 |
| AI 解析 | < 500ms | 1 秒 | API 回應時間 |
| 記帳完成 | < 3 秒 | 5 秒 | 輸入 → 成功 |
| 新增訂閱 | < 1 分鐘 | 2 分鐘 | 開始 → 儲存 |
| 查看分析 | < 2 秒 | 3 秒 | 點擊 → 顯示 |

---

## 🎯 優化建議

### 減少摩擦點
1. **自動登入**: 使用 JWT 持久化 Session
2. **跳過引導**: 允許老用戶直接進入
3. **快速範例**: 提供一鍵填入範例
4. **離線支援**: 離線時仍可記帳，上線同步

### 增加黏性
1. **每日提醒**: 每天 20:00 提醒記帳
2. **成就系統**: 連續記帳 N 天獎勵
3. **社群功能**: 邀請好友一起記帳
4. **數據匯出**: 提供 CSV/PDF 匯出

---

**版本歷史**:
- v1.0 (2025-10-21): 初始版本

**相關文件**:
- [UI 設計系統](../specifications/UI_DESIGN_SYSTEM.md)
- [原型圖](../wireframes/)
- user_story.md
- EVENT_STORMING.md
